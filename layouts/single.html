{{ define "main" }}

<!-- Issue Share Button -->
<div class="issue-share-btn-container">
  <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#issueShareModal" title="Share this issue">
    <i class="bi bi-share"></i>
  </button>
</div>

{{- $categories := dict }}

{{ $post := printf "%s" (string .Params.no) | printf "%s%s" "issue" | printf "%s" }}
{{ with .Params.is_test }}
{{ if . }}
{{ $post = "issue-test" }}
{{ end }}
{{ end }}

{{ $posts := index .Site.Data $post }}

{{ range index $posts.nodes }}
{{ $body := trim .body " \t\n\r" }}
{{ $category := trim (replaceRE `(?s)^(?:\{)(.*)(?:\}).*` "$1" $body) " \t\n\r" }}

{{/* For major releases, store the full entry including metadata */}}
{{ $entry := "" }}
{{ if hasPrefix $category "*" }}
  {{ $entry = trim (replaceRE `(?s)^(?:\{\*)(.*)` "$1" $body) " \t\n\r" }}
  {{ $category = "*" }}
{{ else }}
  {{ $entry = trim (replaceRE `(?s)^(?:\{.*\})(.*)` "$1" $body) " \t\n\r" }}
{{ end }}

{{ $cat := index $categories $category }}
{{ if not $cat }}
{{ $categories = merge $categories (dict $category (dict "category" $category "count" 1 "entries" (slice $entry))) }}
{{ else }}
{{ $categories = merge $categories (dict $category (dict "category" $category "count" (int ($cat.count) | add 1)
"entries" (append $entry $cat.entries))) }}
{{ end }}
{{ end -}}

<div id="issue" >
  <div class="issue-header-card">
    <div class="text-center mb-4">
      <h1 class="display-2 fw-bold">RoundUp â„– {{ .Params.no }}</h1>
      {{- $dateMachine := .Date | time.Format "2006-01-02T15:04:05-07:00" -}}
      {{ $dateHuman := .Date |
      time.Format ":date_full"
      }}
      <p class="lead text-body-tertiary"><i class="bi bi-calendar"></i> <time datetime="{{ $dateMachine }}">{{ $dateHuman }}</time></p>
    </div>

    {{- $header := index $categories "!header" }}
    {{ if $header }}
    <section class="issue-header d-block" >
      {{ range $header.entries }}
        {{ $lines := split . "\n" }}
        {{ range $lines }}
          {{ if gt (len (trim . " \t\n\r")) 0 }}
            <p class="lead fs-4">{{ . | markdownify | partial "emoji.html" }}</p>
          {{ end }}
        {{ end }}
      {{ end }}
    </section>
    {{ end -}}
    
    <div class="text-center mb-4">
      <p class="text-body-secondary small">{{ site.Params.explanation | markdownify }}</p>
      <p class="text-body-secondary lead">{{ "Missed a recent RoundUp? <a href=\"https://roundup.stlgamedev.com\">Browse our ðŸ—„Archive</a> and stay in the loop with STL game development!" | partial "emoji.html" }}</p>
    </div>
  </div>

  
  {{ partial "social-links.html" (dict "showLabel" true) }}

  {{ $important := slice }}
  {{ $majorReleases := slice }}
  {{ range $categories }}
    {{ if strings.Contains .category "#" }}
      {{ $important = $important | append . }}
    {{ else if strings.Contains .category "*" }}
      {{ $majorReleases = $majorReleases | append . }}
    {{ end }}
  {{ end }}

  {{ if gt (len $important) 0 }}
    {{ range $important }}
      <section class="important-section d-block mb-4">
        {{ $tag := replace .category "#" "" }}
        <h3 class="ribbon ribbon-purple">{{ trim $tag " \t\n\r" | title | partial "emoji.html" }}</h3>
        <ul>
          {{ range $index, $entry := .entries }}
            <li class="shareable-entry">
              {{ $entry | markdownify | partial "emoji.html" }}
              {{ partial "youtube-embed.html" $entry }}
              <button type="button" class="btn btn-sm btn-outline-primary entry-share-btn" data-entry-text="{{ $entry | plainify }}" title="Share this announcement">
                <i class="bi bi-share"></i>
              </button>
            </li>
          {{ end }}
        </ul>
      </section>
    {{ end }}
  {{ end }}

  

  {{ if gt (len $majorReleases) 0 }}
    <section class="major-releases-section mb-5">
      <h2 class="display-6 mb-4 text-center">{{ "âœ¨ Major Releases âœ¨" | partial "emoji.html" }}</h2>
      <p class="lead text-body-secondary text-center mb-4">Celebrate these exciting new releases from members of the St Louis Game Development community!</p>
      <div class="major-releases-grid d-flex flex-wrap justify-content-center">
        {{ range $majorReleases }}
          {{ range .entries }}
            {{/* Entry format: Title|URL|ImageURL|Creator} Description */}}
            {{ $parts := split . "}" }}
            {{ if ge (len $parts) 2 }}
              {{ $metadata := index $parts 0 }}
              {{ $description := trim (index $parts 1) " \t\n\r" }}
              {{ $metaParts := split $metadata "|" }}
              {{ if ge (len $metaParts) 4 }}
                {{ $title := trim (index $metaParts 0) " \t\n\r" }}
                {{ $url := trim (index $metaParts 1) " \t\n\r" }}
                {{ $imageUrl := trim (index $metaParts 2) " \t\n\r" }}
                {{ $creator := trim (index $metaParts 3) " \t\n\r" }}
                <div class="major-release-card">
                  <h3 class="major-release-title">
                    <a href="{{ $url }}" target="_blank" rel="noopener">{{ $title }}</a>
                  </h3>
                  <p class="major-release-creator">by {{ $creator }}</p>
                  <div class="major-release-description">{{ $description | markdownify | partial "emoji.html" }}</div>
                  <div class="major-release-image">
                    {{- $image := "" -}}
                    {{- if hasPrefix $imageUrl "http" -}}
                      {{- $image = resources.GetRemote $imageUrl -}}
                      {{- if $image -}}
                        <img src="{{ $image.RelPermalink }}" alt="{{ $title }}" />
                      {{- else -}}
                        <img src="{{ $imageUrl }}" alt="{{ $title }}" />
                      {{- end -}}
                    {{- else -}}
                      {{- $image = resources.Get $imageUrl -}}
                      {{- if $image -}}
                        <img src="{{ $image.RelPermalink }}" alt="{{ $title }}" />
                      {{- else -}}
                        <img src="{{ $imageUrl }}" alt="{{ $title }}" />
                      {{- end -}}
                    {{- end -}}
                  </div>
                  <div class="major-release-actions">
                    <button type="button" class="btn btn-sm major-release-share-btn" data-entry-text="Check out {{ $title }} by {{ $creator }}! {{ $description | plainify }} {{ $url }}" title="Share this release">
                      <i class="bi bi-share"></i> Share
                    </button>
                    <a href="{{ $url }}" target="_blank" rel="noopener" class="btn-play-now"><i class="bi bi-controller"></i> Play Now!</a>
                  </div>
                </div>
              {{ end }}
            {{ end }}
          {{ end }}
        {{ end }}
      </div>
    </section>
  {{ end }}

  <section class="row ">
    <div class="col issue-content">
      {{- range sort $categories "count" "desc" }}
      {{ if and (ne .category "!header") (not (strings.Contains .category "#")) (not (strings.Contains .category "*")) }}
      <section class="issue-section d-block" >
        <h3 class="display-6 pb-2">{{ .category | title | partial "emoji.html" }}</h3>
        <ul>
          {{ range $index, $entry := .entries }}
          <li class="shareable-entry">
            {{ $entry | markdownify | partial "emoji.html" }}
            <button type="button" class="btn btn-sm btn-outline-primary entry-share-btn" data-entry-text="{{ $entry | plainify }}" data-bs-toggle="modal" data-bs-target="#entryShareModal{{ $index }}" title="Share this entry">
              <i class="bi bi-share"></i>
            </button>
          </li>
          {{ end }}
        </ul>
      </section>
      {{ end }}
      {{ end -}}
    </div>
  </section>
</div>

{{ if $posts.events -}}
<div id="events" class="">
  <section class="events-header d-block mb-4">
    <h2 class="display-6 fw-bold">{{ "ðŸ“† Upcoming Events" | partial "emoji.html" }}</h2>
    <p class="lead text-body-tertiary">Participate in these events from our community!</p>
  </section> 
  <section>
  <div class="events-list">
    
  {{ range $posts.events }}   
    {{- $eventImagePath := "images/events/generic.png" -}}
    {{- if strings.Contains .title "GameDev Social" -}}
      {{- $eventImagePath = "images/events/social.png" -}}
    {{- else if strings.Contains .title "Share & Play" -}}
      {{- $eventImagePath = "images/events/shares.png" -}}
    {{- end -}}
    {{- $eventImage := resources.Get $eventImagePath -}}
    <section class="event-appointment shareable-entry">
      <div class="event-time-indicator">
        <div class="event-time-badge text-nowrap">
          <div class="event-date">{{- time.Format "Jan 02" .dateTime | upper -}}</div>
          <div class="event-time">{{ time.Format "03:04 PM" .dateTime }}</div>
        </div>
        {{/* we need to get the meetup id from the event, if there is one */}}
        {{- $description := .description | safeHTML -}}
        {{/* Match and extract the event ID from the RSVP section */}}
        {{- $regex := `(?s)(<br\s*/?>)*\s*For full details, including the address, and to RSVP see:(?:.*)(?:<a[^>]*href=")?https://www\.meetup\.com/st-louis-game-developers/events/([0-9]+)/?(?:".*?>.*?</a>)?` -}}
        {{- $matches := findRESubmatch $regex $description -}}
        {{- if gt (len $matches) 0 -}}
          {{- $firstMatch := index $matches 0 -}}          {{/* the inner []string */}}
          {{- $fullMatch := index $firstMatch 0 -}}        {{/* full matched string */}}
          {{- $eventID := index $firstMatch 2 -}}          {{/* captured group with event ID */}}
          {{- $description = replace $description $fullMatch "" -}}
        <a href="https://www.meetup.com/st-louis-game-developers/events/{{ $eventID }}" target="_blank" rel="noopener" class="btn btn-sm btn-rsvp mt-2"><i class="bi bi-calendar-check"></i> RSVP</a>
        {{- end -}}
      </div>
      <div class="event-details">
        <h4 class="event-title-text">{{ trim .title " \t\n\r" }}</h4>
        {{- if .location -}}
        {{- $displayLocation := trim .location " \t\n\r" | replaceRE `, us$` "" -}}
        <div class="event-location">
          <a href="https://www.google.com/maps/search/?api=1&query={{ .location | urlquery }}" target="_blank" rel="noopener" class="location-link">
            <i class="bi bi-geo-alt-fill"></i> {{ $displayLocation }}
          </a>
        </div>
        {{- end -}}
        {{- if $description -}}
        <div class="event-description">{{ $description | safeHTML }}</div>
        {{- end -}}
      </div>
      <div class="event-image">
        <img src="{{ $eventImage.RelPermalink }}" alt="{{ .title }}" />
      </div>
      <button type="button" class="btn btn-sm btn-outline-primary entry-share-btn" data-entry-text="{{ .title }} - {{ time.Format "Jan 02, 2006" .dateTime }} at {{ time.Format "3:04 PM" .dateTime }}{{ with .location }} - {{ . }}{{ end }}{{ with .description }} - {{ . | plainify }}{{ end }}" title="Share this event">
        <i class="bi bi-share"></i>
      </button>
    </section>
  {{ end }}
    
</div>
</section>
</div> 

{{ end -}}

<div class="row mt-3 pb-2">
  <div class="col-lg-auto">
    <a class="btn btn-outline-danger  btn-sm" role="button"
      href="https://github.com/STLGameDev/STLGameDevRoundUp/blob/main/data/issue{{ .Params.no }}.json"><i
        class="bi bi-pencil-square"></i> Make a Correction</a>
  </div>
</div>
</div>

{{/* Issue Share Modal */}}
{{ $issueShareText := printf "Check out the STLGameDev RoundUp Issue â„– %d\n%s" .Params.no .Permalink }}
{{ partial "share-modal.html" (dict "id" "issueShareModal" "shareText" $issueShareText "shareUrl" .Permalink) }}

{{/* Entry Share Modals - create one shared modal that updates dynamically */}}
<div class="modal fade" id="entryShareModal" tabindex="-1" aria-labelledby="entryShareModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="entryShareModalLabel">Share Entry</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="entryShareText" class="form-label">Share this message:</label>
          <textarea class="form-control share-text" id="entryShareText" rows="4" readonly></textarea>
        </div>
        
        <div class="d-grid gap-2 mb-3">
          <button type="button" class="btn btn-outline-primary btn-copy-text" data-text-id="entryShareText">
            <i class="bi bi-clipboard"></i> Copy Text
          </button>
          <button type="button" class="btn btn-outline-primary btn-copy-link" data-url="{{ .Permalink }}">
            <i class="bi bi-link-45deg"></i> Copy Link
          </button>
        </div>
        
        <div class="mb-2 text-center text-body-secondary small">Or share directly:</div>
        <div class="share-buttons d-flex justify-content-center gap-2 flex-wrap">
          <a href="#" id="entryShareTwitter" target="_blank" rel="noopener" class="btn btn-sm btn-outline-secondary" title="Share on X">
            <i class="bi bi-twitter-x"></i>
          </a>
          <a href="#" id="entryShareBluesky" target="_blank" rel="noopener" class="btn btn-sm btn-outline-secondary" title="Share on Bluesky">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="currentColor" width="16" height="16"><path d="M5.202 2.857C7.954 4.922 10.913 9.11 12 11.358c1.087-2.247 4.046-6.436 6.798-8.501C20.783 1.366 24 .213 24 3.883c0 .732-.42 6.156-.667 7.037-.856 3.061-3.978 3.842-6.755 3.37 4.854.826 6.089 3.562 3.422 6.299-5.065 5.196-7.28-1.304-7.847-2.97-.104-.305-.152-.448-.153-.327 0-.121-.05.022-.153.327-.568 1.666-2.782 8.166-7.847 2.97-2.667-2.737-1.432-5.473 3.422-6.3-2.777.473-5.899-.308-6.755-3.369C.42 10.04 0 4.615 0 3.883c0-3.67 3.217-2.517 5.202-1.026"/></svg>
          </a>
          <a href="#" id="entryShareFacebook" target="_blank" rel="noopener" class="btn btn-sm btn-outline-secondary" title="Share on Facebook">
            <i class="bi bi-facebook"></i>
          </a>
          <a href="#" id="entryShareLinkedIn" target="_blank" rel="noopener" class="btn btn-sm btn-outline-secondary" title="Share on LinkedIn">
            <i class="bi bi-linkedin"></i>
          </a>
          <a href="#" id="entryShareReddit" target="_blank" rel="noopener" class="btn btn-sm btn-outline-secondary" title="Share on Reddit">
            <i class="bi bi-reddit"></i>
          </a>
          <a href="#" id="entryShareEmail" class="btn btn-sm btn-outline-secondary" title="Share via Email">
            <i class="bi bi-envelope"></i>
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Copy text functionality
document.querySelectorAll('.btn-copy-text').forEach(button => {
  button.addEventListener('click', function() {
    const textId = this.getAttribute('data-text-id');
    const textarea = document.getElementById(textId);
    textarea.select();
    navigator.clipboard.writeText(textarea.value).then(() => {
      const originalHTML = this.innerHTML;
      this.innerHTML = '<i class="bi bi-check-lg"></i> Copied!';
      setTimeout(() => {
        this.innerHTML = originalHTML;
      }, 2000);
    });
  });
});

// Copy link functionality
document.querySelectorAll('.btn-copy-link').forEach(button => {
  button.addEventListener('click', function() {
    const url = this.getAttribute('data-url');
    navigator.clipboard.writeText(url).then(() => {
      const originalHTML = this.innerHTML;
      this.innerHTML = '<i class="bi bi-check-lg"></i> Copied!';
      setTimeout(() => {
        this.innerHTML = originalHTML;
      }, 2000);
    });
  });
});

// Entry share button functionality (handles all entry types)
document.querySelectorAll('.entry-share-btn, .major-release-share-btn').forEach(button => {
  button.addEventListener('click', function() {
    const entryText = this.getAttribute('data-entry-text');
    const shareText = `From STLGameDev RoundUp Issue â„– {{ .Params.no }}:\n\n${entryText}\n\n{{ .Permalink }}`;
    const shareUrl = '{{ .Permalink }}';
    
    // Update modal content
    document.getElementById('entryShareText').value = shareText;
    document.querySelector('#entryShareModal .btn-copy-link').setAttribute('data-url', shareUrl);
    
    // Update social share links
    document.getElementById('entryShareTwitter').href = `https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}`;
    document.getElementById('entryShareBluesky').href = `https://bsky.app/intent/compose?text=${encodeURIComponent(shareText)}`;
    document.getElementById('entryShareFacebook').href = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareUrl)}`;
    document.getElementById('entryShareLinkedIn').href = `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(shareUrl)}`;
    document.getElementById('entryShareReddit').href = `https://www.reddit.com/submit?url=${encodeURIComponent(shareUrl)}&title=${encodeURIComponent(shareText)}`;
    document.getElementById('entryShareEmail').href = `mailto:?subject=Check this out&body=${encodeURIComponent(shareText)}`;
  });
});

// Show entry share modal
document.querySelectorAll('.entry-share-btn, .major-release-share-btn').forEach(button => {
  button.addEventListener('click', function() {
    const modal = new bootstrap.Modal(document.getElementById('entryShareModal'));
    modal.show();
  });
});
</script>

{{ end }}
