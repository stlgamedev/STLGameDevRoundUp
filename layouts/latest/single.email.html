{{/* Find the latest issue page */}}
{{ $latestIssue := "" }}
{{ $latestNo := 0 }}
{{ range where .Site.RegularPages "Section" "" }}
  {{ if .Params.no }}
    {{ if and (not .Params.is_test) (gt .Params.no $latestNo) }}
      {{ $latestNo = .Params.no }}
      {{ $latestIssue = . }}
    {{ end }}
  {{ end }}
{{ end }}

{{ if $latestIssue }}
{{/* ==== Build same data structures as main single.html ==== */}}
{{ $categories := dict }}

{{ $post := printf "%s" (string $latestIssue.Params.no) | printf "%s%s" "issue" | printf "%s" }}
{{ with $latestIssue.Params.is_test }}
{{ if . }}
{{ $post = "issue-test" }}
{{ end }}
{{ end }}

{{ $posts := index .Site.Data $post }}

{{ range index $posts.nodes }}
{{ $body := trim .body " \t\n\r" }}
{{ $category := trim (replaceRE `(?s)^(?:\{)(.*)(?:\}).*` "$1" $body) " \t\n\r" }}

{{/* For major releases, store full entry including metadata */}}
{{ $entry := "" }}
{{ if hasPrefix $category "*" }}
{{ $entry = trim (replaceRE `(?s)^(?:\{\*)(.*)` "$1" $body) " \t\n\r" }}
{{ $category = "*" }}
{{ else }}
{{ $entry = trim (replaceRE `(?s)^(?:\{.*\})(.*)` "$1" $body) " \t\n\r" }}
{{ end }}

{{ $cat := index $categories $category }}
{{ if not $cat }}
{{ $categories = merge $categories (dict $category (dict "category" $category "count" 1 "entries" (slice $entry))) }}
{{ else }}
{{ $categories = merge $categories (dict $category (dict "category" $category "count" (add (int $cat.count) 1)
"entries" ($cat.entries | append $entry))) }}
{{ end }}
{{ end }}

{{ $header := index $categories "!header" }}

{{ $important := slice }}
{{ $majorReleases := slice }}
{{ range $categories }}
{{ if strings.Contains .category "#" }}
{{ $important = $important | append . }}
{{ else if strings.Contains .category "*" }}
{{ $majorReleases = $majorReleases | append . }}
{{ end }}
{{ end }}

{{- $dateMachine := $latestIssue.Date | time.Format "2006-01-02T15:04:05-07:00" -}}
{{- $dateHuman := $latestIssue.Date | time.Format ":date_full" -}}

{{ $html := $latestIssue.OutputFormats.Get "HTML" }}


{{- $stlru := resources.Get "images/stlgdru-logo-neon.png" }}
  {{ $stlgdlogo := resources.Get "images/stlgd-logo.png" }}
  {{ $stlgdicon := resources.Get "images/stlgd-icon.png" -}}

<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <title>{{ $latestIssue.Title }}</title>

  <!-- Request Work Sans / Noto Color Emoji (clients that ignore this will just fall back) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Noto+Color+Emoji&family=Work+Sans:ital,wght@0,100..900;1,100..900&display=swap"
    rel="stylesheet">

  <style type="text/css">
  :root {
    /* Theme-matched tokens (mirrors `assets/scss/main.scss`) */
    --bg-page:    #000000;  /* $body-bg */
    --bg-main:    #000000;  /* keep email background consistent with site */
    --bg-card:    #1a1a1a;  /* used in site header + good card contrast */
    --bg-header:  #000000;
    --bg-footer:  #000000;

    --text-main:  #e8e8e8;  /* $body-color */
    --text-muted: rgba(255,255,255,0.60);

    --border-soft: rgba(255,255,255,0.15); /* $border-color */

    --accent:     #E48723;  /* $link-color */
    --accent-alt: #F5E92F;  /* $link-hover-color */
  }

  body {
    margin: 0;
    padding: 0;
    background-color: #000000;
    -webkit-text-size-adjust: none;
  }

  table {
    border-collapse: collapse;
  }

  img {
    border: 0;
    line-height: 100%;
    outline: none;
    text-decoration: none;
    display: block;
  }

  a {
    color: var(--accent);
  }

  /* Common text colors */
  .text-primary { color: var(--accent); }
  .text-muted   { color: var(--text-muted); }

  /* Vertical spacing & separation */
  .py-4 { padding-top: 32px !important; padding-bottom: 32px !important; }
  .my-4 { margin-top: 32px !important; margin-bottom: 32px !important; }
  .mt-3 { margin-top: 24px !important; }
  .mb-3 { margin-bottom: 24px !important; }
  .mt-4 { margin-top: 32px !important; }
  .mb-4 { margin-bottom: 32px !important; }
  .mt-5 { margin-top: 40px !important; }
  .mb-5 { margin-bottom: 40px !important; }
  .px-3 { padding-left: 24px !important; padding-right: 24px !important; }

  hr {
    border: 0;
    border-top: 1px solid var(--border-soft);
    margin: 32px 0;
  }

  /* Layout containers */
  .body-wrapper {
    background-color: var(--bg-page);
    width: 100%;
  }

  .main-container {
    width: 100%;
    max-width: 600px;
    margin: 0 auto;
    background-color: var(--bg-main);
    font-family: 'Work Sans', ui-sans-serif, system-ui, sans-serif, 'Noto Color Emoji';
    font-size: 16px;
    line-height: 1.5;
    color: var(--text-main);
  }

  /* Header & footer boxes */
  .header-box,
  .footer-box {
    background-color: var(--bg-header);
    padding: 32px 24px;
    text-align: center;
    color: var(--text-main);
  }

  .header-box img {
    margin: 0 auto;
  }

  .header-box h1 {
    margin: 12px 0 0 0;
    font-size: 32px;
    font-weight: 700;
  }

  .header-box .subtitle {
    margin: 8px 0 0 0;
    font-size: 16px;
    color: var(--text-muted);
  }

  .footer-box {
    border-top: 1px solid var(--border-soft);
    font-size: 14px;
    color: var(--text-muted);
  }
  .footer-box a {
    color: var(--accent);
    text-decoration: underline;
  }

  /* Content area */
  .content-area {
    padding: 32px 24px;
  }

  /* Typography */
  h2 {
    margin: 32px 0 16px 0;
    font-size: 24px;
    font-weight: 700;
    color: var(--text-main);
  }

  h3 {
    margin: 24px 0 12px 0;
    font-size: 20px;
    font-weight: 600;
    color: var(--text-main);
  }

  p {
    margin: 0 0 16px 0;
  }

  ul, ol {
    margin: 0 0 16px 0;
    padding-left: 24px;
  }

  li {
    margin-bottom: 8px;
  }

  code {
    background-color: rgba(255,255,255,0.1);
    padding: 2px 6px;
    border-radius: 3px;
    font-family: 'Courier New', monospace;
    font-size: 14px;
  }

  pre {
    background-color: rgba(255,255,255,0.05);
    border: 1px solid var(--border-soft);
    border-radius: 6px;
    padding: 16px;
    overflow-x: auto;
    margin: 16px 0;
  }

  pre code {
    background: none;
    padding: 0;
  }

  blockquote {
    border-left: 4px solid var(--accent);
    padding-left: 16px;
    margin: 16px 0;
    color: var(--text-muted);
    font-style: italic;
  }

  /* Issue entry cards */
  .issue-entry {
    background-color: var(--bg-card);
    border: 1px solid var(--border-soft);
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
  }

  .issue-entry h3 {
    margin-top: 0;
  }

  .issue-entry p:last-child {
    margin-bottom: 0;
  }

  /* Category badges */
  .category-header {
    display: flex;
    align-items: center;
    margin: 32px 0 20px 0;
  }

  .category-badge {
    background-color: rgba(255,255,255,0.15);
    color: var(--text-main);
    padding: 4px 10px;
    border-radius: 16px;
    font-size: 14px;
    font-weight: 600;
    margin-left: 8px;
  }

  /* Featured section gets special treatment */
  .featured-entry {
    background: linear-gradient(135deg, rgba(228,135,35,0.1) 0%, rgba(245,233,47,0.1) 100%);
    border: 2px solid var(--accent);
    border-radius: 8px;
    padding: 24px;
    margin-bottom: 24px;
  }

  .featured-entry h3 {
    margin-top: 0;
    color: var(--accent-alt);
  }

  /* Responsive tweaks */
  @media only screen and (max-width: 600px) {
    .main-container {
      width: 100% !important;
    }
    .content-area {
      padding: 20px 16px !important;
    }
    .header-box,
    .footer-box {
      padding: 20px 16px !important;
    }
  }

  /* Dark mode overrides (some clients support this) */
  @media (prefers-color-scheme: dark) {
    body {
      background-color: #000000;
    }
  }
  </style>
</head>

<body>
  <table role="presentation" class="body-wrapper" width="100%" cellspacing="0" cellpadding="0">
    <tr>
      <td align="center">
        <table role="presentation" class="main-container" width="600" cellspacing="0" cellpadding="0">
          
          <!-- Header -->
          <tr>
            <td class="header-box">
              {{ with $stlru }}
              <img src="{{ .Permalink }}" alt="STL Game Dev RoundUp" width="200" style="max-width: 200px;">
              {{ end }}
              <h1>RoundUp ‚Ññ {{ $latestIssue.Params.no }}</h1>
              <p class="subtitle">
                <time datetime="{{ $dateMachine }}">{{ $dateHuman }}</time>
              </p>
              {{ if $html }}
              <p style="margin-top: 16px;">
                <a href="{{ .Site.BaseURL }}{{ $html.RelPermalink }}" style="color: var(--accent-alt); text-decoration: none; font-weight: 600;">
                  View in Browser ‚Üí
                </a>
              </p>
              {{ end }}
            </td>
          </tr>

          <!-- Content -->
          <tr>
            <td class="content-area">

              {{- if $header }}
              <div style="margin-bottom: 32px;">
                {{ range $header.entries }}
                  {{ $lines := split . "\n" }}
                  {{ range $lines }}
                    {{- . | $latestIssue.RenderString (dict "display" "block") -}}
                  {{ end }}
                {{ end }}
              </div>
              <hr>
              {{ end -}}

              {{- $featured := index $categories "*" }}
              {{ if $featured }}
              <div style="margin: 32px 0;">
                <h2 style="margin-top: 0;">‚≠ê Featured</h2>
                {{- range $featured.entries }}
                  <div class="featured-entry">
                    <h3>{{ replaceRE `(?s)^([^\n]+).*` "$1" . }}</h3>
                    {{- $lines := split (replaceRE `(?s)^[^\n]+(.*)` "$1" .) "\n" -}}
                    {{- range $lines -}}
                      {{- . | $latestIssue.RenderString (dict "display" "block") -}}
                    {{- end -}}
                  </div>
                {{- end }}
              </div>
              {{ end -}}

              {{- range sort $categories "category" "asc" }}
                {{- if and (not (or (eq .category "!header") (eq .category "*"))) (gt .count 0) -}}
                <div style="margin: 32px 0;">
                  <div class="category-header">
                    <h2 style="margin: 0;">üîñ {{ .category }}</h2>
                    <span class="category-badge">{{ .count }}</span>
                  </div>
                  {{ range .entries }}
                  <div class="issue-entry">
                    {{- $lines := split . "\n" }}
                    {{ range $lines }}
                    {{- . | $latestIssue.RenderString (dict "display" "block") -}}
                    {{ end }}
                  </div>
                  {{ end }}
                </div>
                {{- end -}}
              {{ end }}

              <hr style="margin: 40px 0;">

              <div style="text-align: center; padding: 24px 0;">
                <h2>Share This Issue</h2>
                {{ $shareText := printf .Site.Params.shareText $latestIssue.Params.no }}
                {{ $shareURL := printf "%s%s" .Site.BaseURL $latestIssue.RelPermalink }}
                <p style="margin: 20px 0;">
                  <a href="https://twitter.com/intent/tweet?text={{ $shareText | urlquery }}&url={{ $shareURL | urlquery }}" 
                     style="display: inline-block; margin: 0 8px; color: var(--accent); text-decoration: none; font-weight: 600;">
                    Share on ùïè
                  </a>
                  <span style="color: var(--text-muted);">‚Ä¢</span>
                  <a href="https://www.facebook.com/sharer/sharer.php?u={{ $shareURL | urlquery }}" 
                     style="display: inline-block; margin: 0 8px; color: var(--accent); text-decoration: none; font-weight: 600;">
                    Share on Facebook
                  </a>
                  <span style="color: var(--text-muted);">‚Ä¢</span>
                  <a href="https://www.linkedin.com/sharing/share-offsite/?url={{ $shareURL | urlquery }}" 
                     style="display: inline-block; margin: 0 8px; color: var(--accent); text-decoration: none; font-weight: 600;">
                    Share on LinkedIn
                  </a>
                </p>
              </div>

            </td>
          </tr>

          <!-- Footer -->
          <tr>
            <td class="footer-box">
              {{ with $stlgdlogo }}
              <img src="{{ .Permalink }}" alt="STL Game Dev" width="120" style="max-width: 120px; margin: 0 auto 16px;">
              {{ end }}
              <p style="margin: 0 0 12px 0;">
                {{ .Site.Params.explanation }}
              </p>
              <p style="margin: 12px 0 0 0;">
                <a href="{{ .Site.Params.github }}">GitHub</a> ‚Ä¢ 
                <a href="{{ .Site.BaseURL }}">View All Issues</a>
              </p>
              <p style="margin: 16px 0 0 0; font-size: 12px;">
                ¬© {{ now.Year }} STL Game Dev. All rights reserved.
              </p>
            </td>
          </tr>

        </table>
      </td>
    </tr>
  </table>
</body>
</html>
{{ else }}
<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>No Issues Found</title>
</head>
<body style="font-family: sans-serif; padding: 40px; text-align: center;">
  <h1>No Issues Found</h1>
  <p>There are no published issues yet.</p>
</body>
</html>
{{ end }}
